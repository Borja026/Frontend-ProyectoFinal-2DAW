<div id="partidas">
  <div>
    <div id="calendario">
      <app-calendario (fechaSeleccionada)="cargarReservasPorFecha($event)"></app-calendario>
    </div>
    <div id="info">
      <h2>¿Necesitas ayuda?</h2>
      <h3>678 737 555</h3>
      <h3>607 367 494</h3>
    </div>
    <div id="leyenda">
      <img src="https://borja.com.es/ProyectoDosDAW/imgs/pistas/Leyenda_Pistas.png" alt="leyenda de las pistas" />
    </div>
  </div>

  <div class="pistas-container">
    <div class="pista" *ngFor="let pista of pistas; let i = index">
      <img [src]="'https://borja.com.es/ProyectoDosDAW/imgs/pistas/' + pista.imagePista" alt="Pista {{ pista.idPista }}"
        [attr.data-id]="pista.idPista" [attr.data-hora]="pista.hora" (click)="onImageClick($event, i)" />

      <div class="info">
        <strong>Pista {{ pista.idPista }}</strong> - {{ pista.hora }}<br />
        Apuntados: {{ pista.apuntados }} / 4
      </div>

      <div *ngIf="pista.jugadores?.length" class="jugadores">
        <h4>Jugadores:</h4>
        <ul>
          <li *ngFor="let jugador of pista.jugadores">
            {{ jugador.correoClientes }} - Niveles: {{ parseNiveles(jugador.nivelPersonas).join(', ') }} - Media: {{ jugador.mediaNivel }}
          </li>
        </ul>
      </div>

      <!-- BOTONES DE ACCIÓN -->
      <div *ngIf="activeIndex === i && showButtons && pista.apuntados < 4" class="acciones">
        <button (click)="apuntarseSolo()">Apuntarse solo</button>

        <ng-container *ngIf="pista.apuntados <= 2">
          <button *ngIf="pista.apuntados <= 2" (click)="apuntarseConAmigos(1)">Apuntarse con 1 amigo</button>
          <button *ngIf="pista.apuntados <= 1" (click)="apuntarseConAmigos(2)">Apuntarse con 2 amigos</button>
          <button *ngIf="pista.apuntados === 0" (click)="apuntarseConAmigos(3)">Reservar la pista</button>
        </ng-container>

        <button (click)="showButtons = false">Cancelar</button>

        <!-- Botón condicional corregido -->
        <button *ngIf="clienteTieneReserva(pista)" (click)="cancelarReserva(pista)">
          Cancelar mi reserva
        </button>
      </div>

      <!-- FORMULARIO PARA NIVEL DE AMIGOS -->
      <div *ngIf="showFriendLevels && activeIndex === i" class="niveles-amigos">
        <div *ngFor="let nivel of friendLevels; let j = index">
          <label>Invitado {{ j + 1 }}:</label>
          <select [(ngModel)]="friendLevels[j]">
            <option *ngFor="let val of [1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5]" [value]="val">
              {{ val }}
            </option>
          </select>
        </div>
        <button (click)="guardarNivelesAmigos(i)">Guardar</button>
        <button (click)="showFriendLevels = false">Cancelar</button>
      </div>
    </div>
  </div>
</div>